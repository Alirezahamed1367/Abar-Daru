<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” Debug Token - Ø³ÛŒØ³ØªÙ… Ø§Ù†Ø¨Ø§Ø± Ø¯Ø§Ø±Ùˆ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Tahoma, Arial, sans-serif;
            direction: rtl;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        h1 { color: #667eea; margin-bottom: 20px; }
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .log-entry { margin: 5px 0; }
        .log-success { color: #00ff00; }
        .log-error { color: #ff0000; }
        .log-warning { color: #ffaa00; }
        .log-info { color: #00aaff; }
        button {
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-test { background: #667eea; color: white; }
        .btn-login { background: #4caf50; color: white; }
        .btn-clear { background: #f44336; color: white; }
        .btn-refresh { background: #2196F3; color: white; }
        .status-box {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 5px solid;
        }
        .status-ok { background: #c8e6c9; border-color: #4caf50; }
        .status-fail { background: #ffcdd2; border-color: #f44336; }
        .status-warn { background: #fff9c4; border-color: #ffeb3b; }
        .login-form {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        .login-form input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .form-active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Debug & Test Token Authentication</h1>
        
        <div id="statusBox" class="status-box status-warn">
            <strong>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</strong>
        </div>
        
        <div>
            <button class="btn-test" onclick="checkEverything()">ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…</button>
            <button class="btn-login" onclick="toggleLoginForm()">ğŸ”‘ ÙØ±Ù… Ù„Ø§Ú¯ÛŒÙ†</button>
            <button class="btn-test" onclick="testTransferAPI()">ğŸ“¦ ØªØ³Øª API Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡</button>
            <button class="btn-test" onclick="exportLogs()">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§</button>
            <button class="btn-clear" onclick="clearStorage()">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Storage</button>
            <button class="btn-refresh" onclick="location.reload()">ğŸ”„ Ø±ÙØ±Ø´</button>
        </div>
        
        <div id="loginForm" class="login-form">
            <h3>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ…</h3>
            <input type="text" id="username" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" value="admin">
            <input type="password" id="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" value="admin">
            <button class="btn-login" onclick="doLogin()">ÙˆØ±ÙˆØ¯</button>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">[System] Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø³ØªÙˆØ±...</div>
        </div>
    </div>

    <script>
        // Auto-detect API base - works both from file:// and http://
        const hostname = window.location.hostname || 'localhost';
        const API_BASE = `http://${hostname}:8000/api`;
        let logCounter = 0;
        let allLogs = []; // Save all logs even after page refresh
        
        function log(message, type = 'info') {
            logCounter++;
            const time = new Date().toLocaleTimeString('fa-IR');
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${time}] ${logCounter}. ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            
            // Save to array for export
            allLogs.push({
                time,
                counter: logCounter,
                message,
                type
            });
            
            // Auto-save to localStorage
            try {
                localStorage.setItem('debug_logs', JSON.stringify(allLogs));
            } catch(e) {
                console.error('Failed to save logs:', e);
            }
        }
        
        function updateStatus(message, type) {
            const box = document.getElementById('statusBox');
            box.innerHTML = `<strong>${message}</strong>`;
            box.className = `status-box status-${type}`;
        }
        
        function toggleLoginForm() {
            const form = document.getElementById('loginForm');
            form.classList.toggle('form-active');
        }
        
        async function doLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            log(`ğŸ” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ú©Ø§Ø±Ø¨Ø±: ${username}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/login?username=${username}&password=${password}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚! Token Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯`, 'success');
                    log(`Token: ${data.access_token.substring(0, 30)}...`, 'success');
                    log(`User: ${data.user.full_name} (${data.user.access_level})`, 'success');
                    
                    localStorage.setItem('token', data.access_token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    updateStatus('âœ… Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚ - Token Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'ok');
                    toggleLoginForm();
                    checkEverything();
                } else {
                    const error = await response.text();
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯ÛŒÙ†: ${error}`, 'error');
                    updateStatus('âŒ Ù„Ø§Ú¯ÛŒÙ† Ù†Ø§Ù…ÙˆÙÙ‚', 'fail');
                }
            } catch (err) {
                log(`âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${err.message}`, 'error');
                updateStatus('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡', 'fail');
            }
        }
        
        async function checkEverything() {
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ” Ø´Ø±ÙˆØ¹ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…...', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            // 1. Check localStorage
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            
            log('ğŸ“¦ Ø¨Ø±Ø±Ø³ÛŒ localStorage:', 'info');
            log(`   Token Ù…ÙˆØ¬ÙˆØ¯: ${token ? 'Ø¨Ù„Ù‡ âœ…' : 'Ø®ÛŒØ± âŒ'}`, token ? 'success' : 'error');
            if (token) {
                log(`   Token Length: ${token.length}`, 'info');
                log(`   Token Preview: ${token.substring(0, 50)}...`, 'info');
            }
            log(`   User Ù…ÙˆØ¬ÙˆØ¯: ${user ? 'Ø¨Ù„Ù‡ âœ…' : 'Ø®ÛŒØ± âŒ'}`, user ? 'success' : 'error');
            if (user) {
                const userData = JSON.parse(user);
                log(`   Username: ${userData.username}`, 'info');
                log(`   Full Name: ${userData.full_name}`, 'info');
                log(`   Access Level: ${userData.access_level}`, 'info');
            }
            
            // 2. Test Backend Connection
            log('', 'info');
            log('ğŸŒ ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Backend:', 'info');
            try {
                const response = await fetch(`${API_BASE}/drugs`);
                log(`   Status: ${response.status} ${response.ok ? 'âœ…' : 'âŒ'}`, response.ok ? 'success' : 'error');
                const data = await response.json();
                log(`   ØªØ¹Ø¯Ø§Ø¯ Ø¯Ø§Ø±ÙˆÙ‡Ø§: ${data.length}`, 'success');
            } catch (err) {
                log(`   âŒ Ø®Ø·Ø§: ${err.message}`, 'error');
            }
            
            // 3. Test with Token
            if (token) {
                log('', 'info');
                log('ğŸ” ØªØ³Øª API Ø¨Ø§ Token:', 'info');
                try {
                    const response = await fetch(`${API_BASE}/transfer/all`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    log(`   Status: ${response.status} ${response.ok ? 'âœ…' : 'âŒ'}`, response.ok ? 'success' : 'error');
                    if (!response.ok) {
                        const error = await response.text();
                        log(`   Error: ${error}`, 'error');
                    } else {
                        const data = await response.json();
                        log(`   âœ… Ù…ÙˆÙÙ‚! ØªØ¹Ø¯Ø§Ø¯ Ø­ÙˆØ§Ù„Ù‡â€ŒÙ‡Ø§: ${data.length}`, 'success');
                    }
                } catch (err) {
                    log(`   âŒ Ø®Ø·Ø§: ${err.message}`, 'error');
                }
            }
            
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('âœ… Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ù…Ù„ Ø´Ø¯!', 'success');
            
            if (token && user) {
                updateStatus('âœ… Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª - Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø­ÙˆØ§Ù„Ù‡ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯', 'ok');
            } else {
                updateStatus('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯', 'warn');
            }
        }
        
        async function testTransferAPI() {
            const token = localStorage.getItem('token');
            if (!token) {
                log('âŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯!', 'error');
                updateStatus('âŒ ØªÙˆÚ©Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯', 'fail');
                return;
            }
            
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ“¦ ØªØ³Øª API Ø«Ø¨Øª Ø­ÙˆØ§Ù„Ù‡...', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            // Test creating a transfer
            const testData = {
                source_warehouse_id: 1,
                drug_id: 1,
                expire_date: '2026-01',
                quantity: 1,
                destination_warehouse_id: 2,
                transfer_type: 'warehouse'
            };
            
            log(`ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Token...`, 'info');
            log(`   URL: ${API_BASE}/transfer/create`, 'info');
            log(`   Data: ${JSON.stringify(testData, null, 2)}`, 'info');
            log(`   Token: ${token.substring(0, 30)}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/transfer/create?${new URLSearchParams(testData)}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                log(`ğŸ“¥ Ù¾Ø§Ø³Ø® Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯:`, 'info');
                log(`   Status: ${response.status}`, response.ok ? 'success' : 'error');
                log(`   OK: ${response.ok}`, response.ok ? 'success' : 'error');
                
                const responseText = await response.text();
                log(`   Response: ${responseText}`, response.ok ? 'success' : 'error');
                
                if (response.ok) {
                    log('âœ… Ø­ÙˆØ§Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!', 'success');
                    updateStatus('âœ… Ø­ÙˆØ§Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯', 'ok');
                } else {
                    log(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª: ${responseText}`, 'error');
                    updateStatus(`âŒ Ø®Ø·Ø§: ${responseText}`, 'fail');
                }
            } catch (err) {
                log(`âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${err.message}`, 'error');
                updateStatus('âŒ Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡', 'fail');
            }
        }
        
        function clearStorage() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ')) {
                // Don't clear logs
                const logs = localStorage.getItem('debug_logs');
                localStorage.clear();
                if (logs) {
                    localStorage.setItem('debug_logs', logs);
                }
                log('ğŸ—‘ï¸ localStorage Ù¾Ø§Ú© Ø´Ø¯ (Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø­ÙØ¸ Ø´Ø¯Ù†Ø¯)', 'warning');
                updateStatus('âš ï¸ Storage Ù¾Ø§Ú© Ø´Ø¯ - Ù„Ø·ÙØ§Ù‹ Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯', 'warn');
            }
        }
        
        function exportLogs() {
            const logsText = allLogs.map(l => `[${l.time}] ${l.counter}. ${l.message}`).join('\n');
            const blob = new Blob([logsText], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug-logs-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('ğŸ’¾ Ù„Ø§Ú¯â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯', 'success');
        }
        
        // Auto check on load
        window.onload = () => {
            // Load previous logs if exist
            try {
                const savedLogs = localStorage.getItem('debug_logs');
                if (savedLogs) {
                    allLogs = JSON.parse(savedLogs);
                    logCounter = allLogs.length;
                    log('ğŸ“‚ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯', 'info');
                }
            } catch(e) {
                console.error('Failed to load logs:', e);
            }
            
            log(`ğŸŒ API Base: ${API_BASE}`, 'info');
            checkEverything();
        };
    </script>
</body>
</html>
